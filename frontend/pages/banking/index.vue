<template>
    <div class="max-w-2xl mx-auto space-y-4">
        <div class="bg-white border rounded-lg p-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500">จำนวนเงินคงเหลือ</p>
                    <p class="text-3xl font-semibold">{{ new Intl.NumberFormat('th-TH').format(balance) }} บาท</p>
                </div>
                <span
                    class="uppercase text-xs bg-red-50 text-red-700 border border-red-200 rounded px-2 py-1">Wallet</span>
            </div>
        </div>

        <div class="bg-white border rounded-lg">
            <div class="border-b px-4 py-3">
                <div class="flex items-center gap-2">
                    <Icon name="heroicons:banknotes-20-solid" class="text-red-600" />
                    <h2 class="font-semibold">ทำรายการฝาก/ถอน</h2>
                </div>
            </div>
            <div class="p-4 space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">จำนวนเงิน *</label>
                    <p class="text-xs text-gray-500 mb-1">กรอกเฉพาะตัวเลข 0 – 100,000 บาท</p>
                    <div class="relative">
                        <input v-model="form.amount" inputmode="numeric" placeholder="เช่น 1,000"
                            class="w-full rounded border px-3 py-2 pr-16 focus:outline-none focus:ring-2 focus:ring-red-600" />
                        <span class="absolute inset-y-0 right-3 flex items-center text-gray-500">บาท</span>
                    </div>
                </div>
                <div class="flex gap-3 justify-center">
                    <button
                        class="inline-flex items-center rounded bg-red-600 text-white px-4 py-2 text-sm font-medium hover:bg-red-700"
                        @click="() => { submit('deposit') }">
                        <svg class="w-4 h-4 mr-2" viewBox="0 0 16 16" fill="currentColor"
                            xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
                            <path
                                d="M8 2.2069V8.00003C8 8.13264 7.94732 8.25981 7.85355 8.35358C7.75979 8.44735 7.63261 8.50003 7.5 8.50003C7.36739 8.50003 7.24021 8.44735 7.14645 8.35358C7.05268 8.25981 7 8.13264 7 8.00003V2.2069L5.85375 3.35378C5.75993 3.4476 5.63268 3.50031 5.5 3.50031C5.36732 3.50031 5.24007 3.4476 5.14625 3.35378C5.05243 3.25996 4.99972 3.13271 4.99972 3.00003C4.99972 2.86735 5.05243 2.7401 5.14625 2.64628L7.14625 0.646277C7.19269 0.599789 7.24783 0.562909 7.30853 0.537747C7.36923 0.512585 7.43429 0.499634 7.5 0.499634C7.56571 0.499634 7.63077 0.512585 7.69147 0.537747C7.75217 0.562909 7.80731 0.599789 7.85375 0.646277L9.85375 2.64628C9.94757 2.7401 10.0003 2.86735 10.0003 3.00003C10.0003 3.13271 9.94757 3.25996 9.85375 3.35378C9.75993 3.4476 9.63268 3.50031 9.5 3.50031C9.36732 3.50031 9.24007 3.4476 9.14625 3.35378L8 2.2069ZM12 7.72628V6.00003C12 5.73481 11.8946 5.48046 11.7071 5.29292C11.5196 5.10538 11.2652 5.00003 11 5.00003H10C9.86739 5.00003 9.74021 5.05271 9.64645 5.14647C9.55268 5.24024 9.5 5.36742 9.5 5.50003C9.5 5.63264 9.55268 5.75981 9.64645 5.85358C9.74021 5.94735 9.86739 6.00003 10 6.00003H11V11.025C10.7018 10.7204 10.3027 10.5351 9.87762 10.5039C9.45251 10.4727 9.03062 10.5977 8.69115 10.8555C8.35167 11.1132 8.11795 11.486 8.03384 11.9039C7.94974 12.3218 8.02105 12.756 8.23438 13.125L8.24938 13.1488L9.64062 15.2738C9.71323 15.3848 9.82694 15.4623 9.95675 15.4895C10.0866 15.5166 10.2218 15.4911 10.3328 15.4185C10.4438 15.3459 10.5214 15.2321 10.5485 15.1023C10.5756 14.9725 10.5501 14.8373 10.4775 14.7263L9.09437 12.6144C8.99633 12.4413 8.97107 12.2363 9.02417 12.0445C9.07727 11.8528 9.20436 11.6899 9.3775 11.5919C9.55064 11.4939 9.75563 11.4686 9.94739 11.5217C10.1391 11.5748 10.302 11.7019 10.4 11.875C10.4044 11.8832 10.4094 11.8913 10.4144 11.8988L11.0819 12.9182C11.1409 13.0081 11.2273 13.0767 11.3284 13.1136C11.4295 13.1505 11.5398 13.1539 11.6429 13.1231C11.746 13.0924 11.8364 13.0292 11.9008 12.943C11.9651 12.8567 11.9999 12.752 12 12.6444V9.00003C12.4713 9.43628 12.8477 9.96491 13.1057 10.553C13.3638 11.141 13.498 11.776 13.5 12.4182V15C13.5 15.1326 13.5527 15.2598 13.6464 15.3536C13.7402 15.4473 13.8674 15.5 14 15.5C14.1326 15.5 14.2598 15.4473 14.3536 15.3536C14.4473 15.2598 14.5 15.1326 14.5 15V12.4157C14.4972 11.4894 14.2679 10.5779 13.8322 9.7606C13.3964 8.94327 12.7674 8.24488 12 7.72628ZM5 5.00003H4C3.73478 5.00003 3.48043 5.10538 3.29289 5.29292C3.10536 5.48046 3 5.73481 3 6.00003V12.5C3 12.6326 3.05268 12.7598 3.14645 12.8536C3.24021 12.9473 3.36739 13 3.5 13C3.63261 13 3.75979 12.9473 3.85355 12.8536C3.94732 12.7598 4 12.6326 4 12.5V6.00003H5C5.13261 6.00003 5.25979 5.94735 5.35355 5.85358C5.44732 5.75981 5.5 5.63264 5.5 5.50003C5.5 5.36742 5.44732 5.24024 5.35355 5.14647C5.25979 5.05271 5.13261 5.00003 5 5.00003Z" />
                        </svg>
                        ฝาก
                    </button>
                    <button
                        class="inline-flex items-center rounded bg-red-100 text-red-700 px-4 py-2 text-sm font-medium hover:bg-red-200"
                        @click="() => { submit('withdraw') }">
                        <svg class="w-4 h-4 mr-2" viewBox="0 0 16 16" fill="currentColor"
                            xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
                            <path
                                d="M14.5 12.4156V15C14.5 15.1326 14.4473 15.2598 14.3536 15.3536C14.2598 15.4473 14.1326 15.5 14 15.5C13.8674 15.5 13.7402 15.4473 13.6464 15.3536C13.5527 15.2598 13.5 15.1326 13.5 15V12.4156C13.4977 11.7738 13.3633 11.1394 13.1052 10.5518C12.8472 9.96419 12.471 9.43597 12 9V12.6469C11.9999 12.7545 11.9651 12.8592 11.9008 12.9454C11.8364 13.0317 11.746 13.0949 11.6429 13.1256C11.5398 13.1564 11.4295 13.153 11.3284 13.1161C11.2273 13.0792 11.1409 13.0106 11.0819 12.9206L10.4144 11.9012C10.4094 11.8937 10.4044 11.8856 10.4 11.8775C10.302 11.7044 10.1391 11.5773 9.94739 11.5242C9.75563 11.4711 9.55064 11.4963 9.3775 11.5944C9.20436 11.6924 9.07727 11.8552 9.02417 12.047C8.97107 12.2387 8.99633 12.4437 9.09437 12.6169L10.4775 14.7288C10.5501 14.8397 10.5756 14.975 10.5485 15.1048C10.5214 15.2346 10.4438 15.3483 10.3328 15.4209C10.2218 15.4935 10.0866 15.5191 9.95675 15.492C9.82694 15.4648 9.71323 15.3872 9.64062 15.2762L8.24938 13.1512L8.23438 13.1275C8.01901 12.7584 7.94613 12.3233 8.02946 11.9042C8.1128 11.4851 8.34659 11.111 8.68676 10.8524C9.02693 10.5938 9.44997 10.4686 9.87609 10.5004C10.3022 10.5322 10.702 10.7188 11 11.025V4H10C9.86739 4 9.74021 3.94732 9.64645 3.85355C9.55268 3.75979 9.5 3.63261 9.5 3.5C9.5 3.36739 9.55268 3.24021 9.64645 3.14645C9.74021 3.05268 9.86739 3 10 3H11C11.2652 3 11.5196 3.10536 11.7071 3.29289C11.8946 3.48043 12 3.73478 12 4V7.72625C12.7674 8.24485 13.3964 8.94324 13.8322 9.76058C14.2679 10.5779 14.4972 11.4894 14.5 12.4156ZM5.5 3.5C5.5 3.36739 5.44732 3.24021 5.35355 3.14645C5.25979 3.05268 5.13261 3 5 3H4C3.73478 3 3.48043 3.10536 3.29289 3.29289C3.10536 3.48043 3 3.73478 3 4V12.5C3 12.6326 3.05268 12.7598 3.14645 12.8536C3.24021 12.9473 3.36739 13 3.5 13C3.63261 13 3.75979 12.9473 3.85355 12.8536C3.94732 12.7598 4 12.6326 4 12.5V4H5C5.13261 4 5.25979 3.94732 5.35355 3.85355C5.44732 3.75979 5.5 3.63261 5.5 3.5ZM9.85375 6.14625C9.80731 6.09976 9.75217 6.06288 9.69147 6.03772C9.63077 6.01256 9.56571 5.99961 9.5 5.99961C9.43429 5.99961 9.36923 6.01256 9.30853 6.03772C9.24783 6.06288 9.19269 6.09976 9.14625 6.14625L8 7.29313V1C8 0.867392 7.94732 0.740215 7.85355 0.646447C7.75979 0.552678 7.63261 0.5 7.5 0.5C7.36739 0.5 7.24021 0.552678 7.14645 0.646447C7.05268 0.740215 7 0.867392 7 1V7.29313L5.85375 6.14625C5.75993 6.05243 5.63268 5.99972 5.5 5.99972C5.36732 5.99972 5.24007 6.05243 5.14625 6.14625C5.05243 6.24007 4.99972 6.36732 4.99972 6.5C4.99972 6.63268 5.05243 6.75993 5.14625 6.85375L7.14625 8.85375C7.19269 8.90024 7.24783 8.93712 7.30853 8.96228C7.36923 8.98744 7.43429 9.00039 7.5 9.00039C7.56571 9.00039 7.63077 8.98744 7.69147 8.96228C7.75217 8.93712 7.80731 8.90024 7.85375 8.85375L9.85375 6.85375C9.90024 6.80731 9.93712 6.75217 9.96228 6.69147C9.98744 6.63077 10.0004 6.56571 10.0004 6.5C10.0004 6.43429 9.98744 6.36923 9.96228 6.30853C9.93712 6.24783 9.90024 6.19269 9.85375 6.14625Z" />
                        </svg>
                        ถอน
                    </button>
                </div>
            </div>
        </div>
    </div>

</template>

<script setup lang="ts">
import { useBanking } from '~/composables/useBanking'

const { balance, fetchBalance, createTransaction } = useBanking()
const toast = useToast()

const form = reactive({ amount: '' })

const rules = {
    amount: (val: string) => {
        if (!val) return 'กรอกจำนวนเงิน'
        const n = Number(val)
        if (!Number.isFinite(n)) return 'จำนวนเงินไม่ถูกต้อง'
        if (n < 0 || n > 100000) return 'ต้องอยู่ระหว่าง 0-100,000'
        return undefined
    }
}

onMounted(() => { fetchBalance().catch(() => { }) })

async function submit(type: 'deposit' | 'withdraw') {
    const err = rules.amount(form.amount)
    if (err) return toast.add({ title: err, color: 'warning' })
    const amt = Number(form.amount)
    try {
        await createTransaction(type, amt)
        form.amount = ''
        toast.add({ title: type === 'deposit' ? 'ฝากสำเร็จ' : 'ถอนสำเร็จ', color: 'success' })
    } catch (e: any) {
        toast.add({ title: e?.message || 'ดำเนินการไม่สำเร็จ', color: 'error' })
    }
}
</script>
